<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>TookWar Dev Board</title>
<style>

*, *::before, *::after {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #0f172a;
    color: #e2e8f0;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
}

header {
    background: #1e293b;
    padding: 1rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: #22c55e;
}

.logo {
    font-weight: 700;
    font-size: 1.3rem;
    user-select: none;
}

#userInfo {
    margin-right: 1rem;
    font-weight: 600;
}

button {
    padding: 0.5rem 1rem;
    font-weight: 600;
    border: none;
    border-radius: 0.5rem;
    background: transparent;
    color: inherit;
    cursor: pointer;
    transition: 0.2s;
    user-select: none;
}

button:focus {
    outline: 2px solid #22c55e;
    outline-offset: 2px;
}

#logoutBtn {
    background: #ef4444;
    color: white;
}

#logoutBtn:hover {
    background: #dc2626;
}

.primary {
    background: #22c55e;
    color: #022c22;
    font-weight: 700;
}

.primary:hover {
    background: #16a34a;
}

.danger {
    background: #dc2626;
    color: white;
    font-weight: 700;
}

.danger:hover {
    background: #b91c1c;
}

.edit-btn {
    background: #2563eb;
    color: white;
}

.edit-btn:hover {
    background: #1d4ed8;
}

#login {
    margin: 100px auto;
    background: #1e293b;
    max-width: 400px;
    padding: 2rem;
    border-radius: 1rem;
    box-shadow: 0 0 15px rgba(34, 197, 94, 0.5);
}

#login h2 {
    margin-bottom: 1.5rem;
    color: #22c55e;
    text-align: center;
}

#login input {
    width: 100%;
    padding: 0.8rem 1rem;
    margin-bottom: 1rem;
    border-radius: 0.6rem;
    border: none;
    font-size: 1rem;
    background: #334155;
    color: #e2e8f0;
}

#login input::placeholder {
    color: #94a3b8;
}

#login button {
    width: 100%;
    font-size: 1.1rem;
    border-radius: 0.6rem;
}

#app {
    flex-grow: 1;
    max-width: 900px;
    margin: 2rem auto 4rem auto;
    padding: 0 1rem;
}

#app h2 {
    border-bottom: 2px solid #22c55e;
    padding-bottom: 0.5rem;
    margin-bottom: 1rem;
}

#auftraege {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.auftrag {
    background: #1e293b;
    border-radius: 1rem;
    padding: 1.5rem 2rem;
    box-shadow: 0 0 15px rgba(34, 197, 94, 0.15);
}

.row {
    display: flex;
    gap: 1rem;
    margin-bottom: 0.9rem;
    align-items: center;
}

.row label {
    min-width: 90px;
    font-weight: 700;
    color: #6ee7b7;
    user-select: none;
}

input[type="text"],
input[type="date"],
select,
textarea {
    background: #334155;
    border: none;
    border-radius: 0.6rem;
    color: #e2e8f0;
    font-size: 1rem;
    padding: 0.5rem 0.8rem;
    flex-grow: 1;
    transition: 0.2s;
}

input:disabled,
select:disabled,
textarea:disabled {
    background: transparent;
    color: #94a3b8;
    cursor: default;
}

textarea {
    min-height: 70px;
    resize: vertical;
    font-family: inherit;
}

.buttons-wrapper {
    margin-top: 1rem;
    text-align: right;
}

button.primary,
button.danger {
    padding: 0.5rem 1.4rem;
}

button.danger {
    margin-left: 0.75rem;
}

#addBtn {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    width: 60px;
    height: 60px;
    font-size: 40px;
    font-weight: 600;
    background: #22c55e;
    border-radius: 50%;
    border: none;
    color: #022c22;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(34, 197, 94, 0.6);
    display: none;
    align-items: center;
    justify-content: center;
    user-select: none;
}

#addBtn:hover {
    background: #16a34a;
}

.editable-text {
    width: 100%;
    min-height: 100px;
    max-height: 300px;
    resize: vertical;
    font-size: 1rem;
    padding: 0.5rem 0.8rem;
    border-radius: 0.6rem;
    background: #334155;
    color: #e2e8f0;
    font-family: inherit;
}

@media (max-width: 550px) {
    .editable-text {
        min-height: 80px;
        font-size: 0.9rem;
    }

    .row {
        flex-direction: column;
        align-items: flex-start;
    }

    .row label {
        margin-bottom: 0.25rem;
    }

    #login {
        width: 90vw;
    }
}

@media (min-width: 551px) and (max-width: 900px) {
    .editable-text {
        min-height: 90px;
        font-size: 0.95rem;
    }
}

@media (min-width: 901px) and (max-width: 1200px) {
    .editable-text {
        min-height: 100px;
        font-size: 1rem;
    }
}

@media (min-width: 1201px) {
    .editable-text {
        min-height: 120px;
        font-size: 1.05rem;
    }
}
</style>
</head>
<body>

<header id="top" style="display:none">
    <div class="logo">TookWar Dev Board</div>
    <div>
        <span id="userInfo"></span>
        <button id="logoutBtn">Logout</button>
    </div>
</header>

<div id="login">
    <h2>Login</h2>
    <input type="email" id="username" placeholder="Email">
    <input type="password" id="password" placeholder="Passwort">
    <button id="loginBtn" class="primary" style="width:100%">Login</button>
</div>

<main id="app" style="display:none">
    <h2 style="margin-bottom: 1rem;">Aktuelle Aufträge</h2>
    <div id="auftraege"></div>
</main>

<button id="addBtn">+</button>

<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

const SUPABASE_URL = 'https://canbmnjlmzxiscmohtqy.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNhbmJtbmpsbXp4aXNjbW9odHF5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczNTMwMDUsImV4cCI6MjA4MjkyOTAwNX0.WxS_wRHL6dARReG1IPAfJV0JeNfWwcvnO2Kg_-qd22o';
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

const STATUS_OPTIONS = ['Offen','In Arbeit','Abgeschlossen','Warten'];
let currentUser = null, roles = [];

const loginEl = document.getElementById('login'), appEl = document.getElementById('app'), topEl = document.getElementById('top'), addBtn = document.getElementById('addBtn');
const auftraegeEl = document.getElementById('auftraege'), usernameEl = document.getElementById('username'), passwordEl = document.getElementById('password');

// --- LOGIN LOGIK ---
document.getElementById('loginBtn').addEventListener('click', async () => {
    const { data, error } = await supabase.auth.signInWithPassword({ 
        email: usernameEl.value, 
        password: passwordEl.value 
    });

    if (error) return alert('Login Fehler: ' + error.message);

    currentUser = data.user.email;
    const { data: profile } = await supabase.from('profiles').select('roles').eq('id', data.user.id).single();
    roles = profile?.roles || [];

    loginEl.style.display = 'none';
    appEl.style.display = 'block';
    topEl.style.display = 'flex';
    document.getElementById('userInfo').textContent = `${currentUser} (${roles.join(', ')})`;
    
    if (roles.includes('admin') || roles.includes('manager')) addBtn.style.display = 'flex';
    
    loadAuftraege();
});

document.getElementById('logoutBtn').addEventListener('click', () => { supabase.auth.signOut(); location.reload(); });

// --- DATEN LADEN ---
async function loadAuftraege() {
    auftraegeEl.innerHTML = '<p>Lade Aufträge...</p>';
    let query = supabase.from('auftraege').select('*').order('createdAt', { ascending: false });
    
    if (roles.includes('dev') && !roles.includes('admin')) {
        query = query.eq('dev', currentUser);
    }

    const { data, error } = await query;
    auftraegeEl.innerHTML = '';

    if (error) return alert('Fehler: ' + error.message);
    if (data.length === 0) auftraegeEl.innerHTML = '<p>Keine Aufträge gefunden.</p>';

    data.forEach(a => {
        const el = createAuftragElement(a);
        if(el) auftraegeEl.appendChild(el);
    });
}

// --- ELEMENT ERSTELLEN ---
function createAuftragElement(a) {
    const div = document.createElement('div');
    div.className = 'auftrag';
    
    const isAdmin = roles.includes('admin') || roles.includes('manager');
    const isDev = roles.includes('dev') && a.dev === currentUser;

    if (!isAdmin && !isDev) return null;

    div.innerHTML = `
        <div class="row"><label>Dev:</label><input type="text" class="d-input" value="${a.dev || ''}" disabled></div>
        <div class="row"><label>Deadline:</label><input type="date" class="l-input" value="${a.deadline || ''}" disabled></div>
        <div class="row"><label>Text:</label><textarea class="t-input" disabled>${a.text || ''}</textarea></div>
        <div class="row"><label>Status:</label><select class="s-input" disabled></select></div>
        <div class="buttons-wrapper" style="text-align:right; margin-top:1rem;">
            <button class="edit-btn">Bearbeiten</button>
            <button class="primary save-btn" style="display:none">Speichern</button>
            <button class="danger cancel-btn" style="display:none">Abbrechen</button>
            ${isAdmin ? '<button class="danger del-btn" style="margin-left:0.5rem">Löschen</button>' : ''}
        </div>
    `;

    const sInp = div.querySelector('.s-input');
    STATUS_OPTIONS.forEach(o => {
        const opt = document.createElement('option');
        opt.value = o; opt.textContent = o;
        if(o === a.status) opt.selected = true;
        sInp.appendChild(opt);
    });

    const editBtn = div.querySelector('.edit-btn'), saveBtn = div.querySelector('.save-btn'), 
          cancelBtn = div.querySelector('.cancel-btn'), delBtn = div.querySelector('.del-btn');
    const inputs = div.querySelectorAll('input, textarea, select');

    editBtn.onclick = () => {
        inputs.forEach(i => i.disabled = false);
        editBtn.style.display = 'none';
        saveBtn.style.display = 'inline-block';
        cancelBtn.style.display = 'inline-block';
    };

    cancelBtn.onclick = () => loadAuftraege();

    saveBtn.onclick = async () => {
        const { error } = await supabase.from('auftraege').update({
            dev: div.querySelector('.d-input').value,
            deadline: div.querySelector('.l-input').value,
            text: div.querySelector('.t-input').value,
            status: sInp.value
        }).eq('id', a.id);
        if(error) alert(error.message); else loadAuftraege();
    };

    if(delBtn) delBtn.onclick = async () => {
        if(confirm('Löschen?')) {
            await supabase.from('auftraege').delete().eq('id', a.id);
            loadAuftraege();
        }
    };

    return div;
}

// --- NEUER AUFTRAG ---
addBtn.onclick = async () => {
    const { data, error } = await supabase.from('auftraege').insert([{
        text: 'Neuer Auftrag...',
        status: 'Offen',
        createdAt: new Date().toISOString()
    }]).select();
    
    if(error) alert(error.message);
    else loadAuftraege();
};

</script>
</body>
</html>
